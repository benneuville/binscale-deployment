---
- name: Deploy Kafka Cluster (Strimzi 0.45.1)
  hosts: localhost

  tasks:
    - name: Apply Strimzi Operator (version 0.45.1)
      command: >
        kubectl create -f
        https://github.com/strimzi/strimzi-kafka-operator/releases/download/0.45.1/strimzi-cluster-operator-0.45.1.yaml
        -n binscale

    # - name: Create Strimzi RBAC fix for Lease permissions
    #   copy:
    #     dest: /tmp/strimzi-rbac-fix.yaml
    #     content: |
    #       apiVersion: rbac.authorization.k8s.io/v1
    #       kind: ClusterRole
    #       metadata:
    #         name: strimzi-cluster-operator-leases
    #       rules:
    #         - apiGroups: ["coordination.k8s.io"]
    #           resources: ["leases"]
    #           verbs: ["get", "list", "watch", "create", "update", "delete"]

    #       ---
    #       apiVersion: rbac.authorization.k8s.io/v1
    #       kind: ClusterRoleBinding
    #       metadata:
    #         name: strimzi-cluster-operator-leases-binding
    #       subjects:
    #         - kind: ServiceAccount
    #           name: strimzi-cluster-operator
    #           namespace: binscale
    #       roleRef:
    #         kind: ClusterRole
    #         name: strimzi-cluster-operator-leases
    #         apiGroup: rbac.authorization.k8s.io

    # - name: Apply Strimzi RBAC fix
    #   command: kubectl apply -f /tmp/strimzi-rbac-fix.yaml


    - name: Apply Kafka Cluster definition (my-cluster)
      command: kubectl apply -f ../kubernetes/kafka-cluster.yaml -n binscale

    - name: Apply Kafka Node Pool definition
      command: kubectl apply -f ../kubernetes/kafka-nodepool.yaml -n binscale

    - name: Apply Kafka Topic
      command: kubectl apply -f ../kubernetes/kafka-topic.yaml -n binscale

    - name: Check Kafka Cluster Readiness
      command: kubectl wait kafka/my-cluster --for=condition=Ready --timeout=300s -n binscale


- name: Deploy Prometheus, Grafana, and related resources
  hosts: localhost

  tasks:
    - name: Apply Prometheus Operator Deployment
      command: kubectl apply -f ../kubernetes/prometheus-operator-deployment.yaml -n binscale

    - name: Apply Prometheus Additional Configuration
      command: kubectl apply -f ../kubernetes/prometheus-additional.yaml -n binscale

    - name: Apply Prometheus Rules
      command: kubectl apply -f ../kubernetes/prometheus-rules.yaml -n binscale

    - name: Apply Strimzi Pod Monitor
      command: kubectl apply -f ../kubernetes/strimzi-pod-monitor.yaml -n binscale

    - name: Apply Prometheus Configuration
      command: kubectl apply -f ../kubernetes/prometheus.yaml -n binscale

    - name: Apply Prometheus Service
      command: kubectl apply -f ../kubernetes/prometheus-service.yaml -n binscale


- name: Deploy Elastic Stack
  hosts: localhost

  tasks:
    - name: Create elastic namespace (if not exists)
      command: kubectl create namespace elastic
      ignore_errors: yes

    - name: Apply Filebeat
      command: kubectl apply -f ../elastic-stack/filebeat-kubernetes.yaml -n elastic
